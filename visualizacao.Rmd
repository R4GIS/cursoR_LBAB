---
title: "Curso R - Visualização de dados"
author: "Ítalo Cegatta"
date: "3 de junho de 2016"
output: html_document
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(warning=FALSE, message=FALSE,
  fig.width=10, fig.height=8, dpi=300, fig.path='imagens/')
```

```{r}
library(pacman)
p_load(readxl, dplyr, tidyr, ggplot2, ggthemes)
```

# Pontos

```{r}
dados <- read_excel("dados_tume.xlsx")

dados

dados <- dados %>% 
  mutate(
    g = (pi/40000)*(dap^2),
    v = g*h*0.42
  )
dados
```

```{r}
ggplot(data = dados) +
  geom_point(aes(x = dap, y = h))
```

```{r}
ggplot(data = dados) +
  geom_point(aes(x = dap, y = h, color = especie))
```

```{r}
ggplot(data = dados) +
  geom_point(aes(x = dap, y = h, color = especie, size = v))
```

```{r}
ggplot(data = dados) +
  geom_point(aes(x = dap, y = h, size = v)) +
  facet_wrap(~especie)
```

```{r}
ggplot(dados, aes(dap, h, size = v)) +
  geom_point() +
  facet_wrap(~especie)
```

```{r}
ggplot(data = dados) +
  geom_point(aes(x = dap, y = h, color = v)) +
  facet_wrap(~especie)
```

# Boxplot

```{r}
dados <- read_excel("base_vespa.xlsx")

dados

dados <- read_excel("base_vespa.xlsx") %>% 
  gather("Local", "Galhas", 3:17) %>% 
  separate(Local, c("Coleta", "Local"))
```

Primeiro vamos processar os dados da última medição (Coleta 5) para verificar o nº total de galhas de cada tratamento, desconsiderando o local da galha. Nesse caso estou considerando apenas as mudas que foram atacadas e tiveram o desenvolvimento de galhas.

```{r}
total <- dados %>%
  filter(Coleta == 5) %>%
  group_by(Tratamento, Individuo) %>%
  summarise(Galhas = sum(Galhas, na.rm=T)) %>%
  mutate(Galhas = replace(Galhas, Galhas == 0, NA))

total
```

O boxplot é um gráfico unidimensional, ou seja, precisamos de apenas uma variável para construí-lo. Entretanto, podemos usar variáveis categóricas para servir de agrupamento e replicar o gráfico para todos os níveis da variável. Por exemplo, no nosso banco de dados temos `Galhas` como variável quantitativa e `Tratamento`, `Coleta` e `Local` como variável qualitativa. 

```{r 4_boxplot_total}
ggplot(total, aes("Total", Galhas)) +
  geom_boxplot() +
  theme_few()
```

A figura dá uma visão geral de todas as observações em um único boxplot, mas não nos explica muita coisa. A variável categórica nos permite subdividir os boxplots para todos os níveis de tratamentos e assim podemos compará-los.

```{r 4_boxplot_trat}
ggplot(total, aes(Tratamento, Galhas)) +
  geom_boxplot() +
  theme_few()
```

Podemos também avaliar a variabilidade do nº de galhas por local. Para isso vamos incluir a variável `Local` no agrupamento.

```{r}
local <- dados %>%
  filter(Coleta == 5) %>%
  group_by(Tratamento, Individuo, Local) %>%
  summarise(Galhas = sum(Galhas, na.rm=T)) %>%
  mutate(Galhas = replace(Galhas, Galhas == 0, NA))

local
```

```{r 4_boxplot_local}
  ggplot(local, aes(Tratamento, Galhas, fill = Local)) +
  geom_boxplot() +
  theme_few() +
  scale_fill_brewer(palette = "Spectral")
```

Uma outra perspectiva é avaliar a evolução do total de galhas por coleta. Para isto basta incluir a variável `Coleta` no agrupamento. Para facilitar a visualização, vou excluir a primeira coleta. Podemos ainda adicionar os pontos que representam as observações para poder identificar quantas observações tem cada tratamento.

```{r}
total_coleta <- dados %>%
  filter(Coleta != 1 ) %>%
  group_by(Tratamento, Coleta, Individuo) %>%
  summarise(Galhas = sum(Galhas, na.rm=T)) %>%
  mutate(Galhas = replace(Galhas, Galhas == 0, NA))

total_coleta
```

```{r 4_boxplot_coleta}
ggplot(total_coleta, aes(Tratamento, Galhas)) +
  geom_boxplot() +
  #geom_jitter(alpha = 0.4) +
  facet_wrap(~ Coleta, labeller = label_both) +
  theme_few() +
  theme(axis.text.x = element_text(angle = 30, hjust = 0.5, vjust = 0.5))
```

# Gráfico de barras

```{r dados}
dados
```

## Básico

A primeira sequência de gráficos está relacionada ao total de galhas encontradas nas mudas de cada tratamento. Nessa comparação, temos de considerar tratamentos como fatores e os locais onde a galha foi encontrada como níveis. Essa distinção vai nos ajuda a escolher a melhor forma de construir um gráfico de acordo com o que queremos mostrar.

```{r total_trat}
total_trat <- dados %>%
  filter(Coleta == 5) %>%
  group_by(Tratamento) %>%
  summarise(Galhas = sum(Galhas, na.rm=T))

total_trat

ggplot(total_trat, aes(Tratamento, Galhas)) +
  geom_bar(stat = "identity") +
  theme_few()
```

Mas ainda temos a variável `Local`, certo? Podemos apresentá-la sem muito esforço.

```{r total_trat_lcoal}
total_trat_local <- dados %>%
  filter(Coleta == 5) %>%
  group_by(Tratamento, Local) %>%
  summarise(Galhas = sum(Galhas, na.rm=T))

total_trat_local

ggplot(total_trat_local, aes(Tratamento, Galhas, fill = Local)) +
  geom_bar(stat = "identity") +
  theme_few() +
  scale_fill_brewer(palette = "Spectral")
```

Podemos dar mais evidência aos níveis, transformando-os em barras.

```{r 5_bar_local_dodge}
ggplot(total_trat_local, aes(Tratamento, Galhas, fill = Local)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_few() +
  scale_fill_brewer(palette = "Spectral")
```

Como alternativa, podemos subdividir os níveis em painéis e deixar o gráfico mais balanceado, ou seja, sem concentrar a informação em fatores ou níveis.

```{r 5_bar_local_facet}
ggplot(total_trat_local, aes(Tratamento, Galhas )) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~Local) +
  theme_few() +
  theme(axis.text.x = element_text(angle = 30, hjust = 0.5, vjust = 0.5))
```

Note que nos 3 gráficos anteriores o banco de dados para formação do gráfico é o mesmo, mas cada um dá ênfase em um aspecto diferente. A parte boa é que podemos modificá-los de acordo com o nosso interesse de uma forma rápida e bem simples.

## Adicionando valores às barras

Se quisermos adicionar o valor de cada nível ou fator na barra, temos de alterar o banco de dados para que ele coincida com o que queremos mostrar.

```{r 5_bar_basico_annot}
ggplot(total_trat, aes(Tratamento, Galhas)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = Galhas), vjust = -0.2) +
  theme_few()
```

Para a próxima figura temos de criar uma coluna que informa a posição em que o valor deve ficar no eixo y, uma vez que ele deve estar exatamente no centro do respectivo compartimento da barra.

```{r 5_bar_local_annot}
total_trat_local_y <- total_trat_local %>%
  mutate(Galhas_y = replace(cumsum(Galhas) - (0.5*Galhas),
    Galhas  ==  0, NA))

ggplot(total_trat_local_y, aes(Tratamento, Galhas, fill = Local)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = Galhas, y = Galhas_y)) +
  theme_few() +
  scale_fill_brewer(palette = "Spectral")
```

```{r 5_bar_local_dodge_annot}
ggplot(total_trat_local, aes(Tratamento, Galhas, fill = Local)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(aes(label = Galhas),
    position = position_dodge(width=0.9), vjust = -0.2) +
  theme_few() +
  scale_fill_brewer(palette = "Spectral")
```

```{r 5_bar_local_facet_annot}
ggplot(total_trat_local, aes(Tratamento, Galhas )) +
  geom_bar(stat = "identity", position = "dodge") +
    geom_text(aes(label = Galhas), vjust = -0.2) +
  facet_wrap(~Local) +
  theme_few() +
  theme(axis.text.x = element_text(angle = 30, hjust = 0.5, vjust = 0.5))
```

## Barra de desvio

Vamos resumir novamente os dados em função da média e acrescentar o erro padrão da média.

```{r media_trat_desv}
media_trat_desv <- dados %>%
  filter(Coleta == 5) %>%
  group_by(Tratamento) %>%
  summarise(desv = sd(Galhas, na.rm=T)/sqrt(n()),
    Galhas = mean(Galhas, na.rm=T))

media_trat_desv
```

Após criar o *data frame* com o desvio, vamos colocar a informação no gráfico.

```{r 5_bar_basico_desv}
ggplot(media_trat_desv, aes(Tratamento, Galhas)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = Galhas - desv,
     ymax = Galhas + desv), width = 0.4) +
  theme_few()
```

```{r total_trat_local_desv}
media_trat_local_desv <- dados %>%
  filter(Coleta == 5) %>%
  group_by(Tratamento, Local) %>%
  summarise(desv = sd(Galhas, na.rm=T)/sqrt(n()),
    Galhas = median(Galhas, na.rm=T))

media_trat_local_desv

ggplot(media_trat_local_desv, aes(Tratamento, Galhas, fill = Local)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = Galhas - desv, ymax = Galhas + desv),
    position = position_dodge(width=0.9), width = 0.4) +
  theme_few() +
  scale_fill_brewer(palette = "Spectral")
```


```{r 5_bar_local_facet_desv}
ggplot(media_trat_local_desv, aes(Tratamento, Galhas )) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = Galhas - desv,
    ymax = Galhas + desv), width = 0.4) +
  facet_wrap(~Local) +
  theme_few() +
  theme(axis.text.x = element_text(angle = 30, hjust = 0.5, vjust = 0.5))
```